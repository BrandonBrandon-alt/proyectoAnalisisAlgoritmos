<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Requerimiento 1 — Duplicados BibTeX</title>
    <style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
  --primary: #7c3aed;
  --primary-dark: #6d28d9;
  --primary-light: #a78bfa;
  --secondary: #06b6d4;
  --background: #0f172a;
  --surface: #1e293b;
  --card: #334155;
  --text: #f1f5f9;
  --text-muted: #94a3b8;
  --accent: #f59e0b;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  background: var(--background);
  color: var(--text);
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
  padding: 20px;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 50%, rgba(124, 58, 237, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(6, 182, 212, 0.15) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

.wrap {
  max-width: 1400px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

h1 {
  font-size: 2.5rem;
  font-weight: 700;
  margin-bottom: 12px;
  background: linear-gradient(135deg, var(--primary-light), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.lead {
  font-size: 1.1rem;
  color: var(--text-muted);
  margin-bottom: 32px;
  line-height: 1.6;
}

.controls {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

button, .btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 0.95rem;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
}

button:hover:not(:disabled), .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(124, 58, 237, 0.5);
}

button:disabled {
  background: var(--card);
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.muted {
  color: var(--text-muted);
  font-size: 0.9rem;
}

.grid {
  display: grid;
  grid-template-columns: 1fr 1.5fr;
  gap: 24px;
  margin-top: 24px;
}

@media (max-width: 1024px) {
  .grid {
    grid-template-columns: 1fr;
  }
}

.card {
  background: var(--surface);
  border-radius: 16px;
  padding: 24px;
  border: 1px solid rgba(148, 163, 184, 0.1);
  transition: all 0.3s;
}

.card:hover {
  border-color: rgba(124, 58, 237, 0.3);
  box-shadow: 0 8px 24px rgba(124, 58, 237, 0.2);
}

.card strong {
  display: block;
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--text);
}

.status {
  padding: 16px;
  background: var(--card);
  border-radius: 10px;
  font-size: 0.95rem;
  border: 1px solid rgba(148, 163, 184, 0.1);
}

.entry-card {
  background: var(--card);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  border: 1px solid rgba(148, 163, 184, 0.1);
  transition: all 0.3s;
}

.entry-card:hover {
  border-color: rgba(124, 58, 237, 0.5);
  transform: translateX(4px);
}

.entry-header {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

.entry-number {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  padding: 4px 12px;
  border-radius: 8px;
  font-weight: 700;
  font-size: 0.85rem;
}

.entry-type {
  background: var(--surface);
  color: var(--accent);
  padding: 4px 12px;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  border: 1px solid rgba(245, 158, 11, 0.3);
}

.entry-id {
  color: var(--text-muted);
  font-size: 0.85rem;
  font-family: 'Courier New', monospace;
}

.entry-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 12px;
  line-height: 1.4;
}

.entry-meta {
  font-size: 0.9rem;
  color: var(--text-muted);
  line-height: 1.6;
}

.entry-meta strong {
  color: var(--primary-light);
  font-size: 0.9rem;
  display: inline;
  margin-bottom: 0;
}

.entry-meta div {
  margin-bottom: 6px;
}

.top-list table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
}

.top-list th {
  background: var(--card);
  color: var(--text);
  padding: 12px;
  text-align: left;
  font-weight: 600;
  border-bottom: 2px solid var(--primary);
}

.top-list td {
  padding: 12px;
  border-bottom: 1px solid rgba(148, 163, 184, 0.1);
}

.top-list tr:hover {
  background: var(--card);
}

pre {
  background: var(--card);
  color: var(--text);
  padding: 16px;
  border-radius: 10px;
  overflow: auto;
  font-family: 'Courier New', monospace;
  font-size: 0.85rem;
  border: 1px solid rgba(148, 163, 184, 0.1);
  line-height: 1.5;
}

code {
  background: var(--card);
  padding: 4px 8px;
  border-radius: 6px;
  font-family: 'Courier New', monospace;
  font-size: 0.85rem;
  color: var(--primary-light);
}

#entriesList {
  max-height: 600px;
  overflow-y: auto;
  padding-right: 8px;
}

#entriesList::-webkit-scrollbar {
  width: 8px;
}

#entriesList::-webkit-scrollbar-track {
  background: var(--card);
  border-radius: 4px;
}

#entriesList::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 4px;
}

#entriesList::-webkit-scrollbar-thumb:hover {
  background: var(--primary-dark);
}
    </style>
</head>
<body>
<div class="wrap">
    <div style="margin-bottom: 24px;">
        <a href="../../index.html" style="display: inline-flex; align-items: center; gap: 8px; color: var(--text-muted); text-decoration: none; font-size: 0.9rem; transition: color 0.3s;">
            <span style="font-size: 1.2rem;">←</span> Volver al inicio
        </a>
    </div>
    
    <h1>Requerimiento 1 — Duplicados BibTeX</h1>
    <p class="lead">Visualización de entradas duplicadas detectadas en el proceso de consolidación BibTeX.</p>

    <div>
        <button id="loadBtn">Cargar duplicados</button>
        <span id="msg" class="muted" style="margin-left:12px"></span>
    </div>

    <div class="grid">
        <div>
            <div id="summary" class="card">
                <strong>Resumen de Duplicados</strong>
                <div class="status" id="summaryText">No se ha cargado ningún archivo todavía.</div>
                <div id="counts" style="margin-top:8px"></div>
            </div>

            <div id="statsCard" class="card" style="margin-top:12px; display:none;">
                <strong>Estadísticas por Tipo</strong>
                <div class="top-list" id="typeStats"></div>
            </div>

            <div id="topAuthorsCard" class="card" style="margin-top:12px; display:none;">
                <strong>Autores más frecuentes en duplicados</strong>
                <div class="top-list" id="topAuthors"></div>
            </div>
        </div>

        <div>
            <div class="card">
                <strong>Entradas Duplicadas</strong>
                <div id="entriesContainer" style="margin-top:8px">
                    <div class="muted">Las entradas duplicadas se mostrarán aquí una vez cargadas.</div>
                    <div id="entriesList" style="margin-top:12px"></div>
                </div>
            </div>

            <div class="card" style="margin-top:12px;">
                <strong>Logs</strong>
                <pre id="log" style="height:220px">Esperando acción...</pre>
            </div>
        </div>
    </div>

    <script>
        // Ruta al archivo de duplicados generado por el notebook
        const paths = {
            duplicates: '../../duplicados/duplicados.bib'
        };

        const logEl = document.getElementById('log');
        function log(...args){ logEl.textContent = args.join(' ') + "\n" + logEl.textContent; }

        function showMsg(text){ document.getElementById('msg').textContent = text; }

        async function fetchText(path){
            try{
                const res = await fetch(path);
                if(!res.ok) throw new Error('HTTP ' + res.status);
                return await res.text();
            } catch(e){
                throw new Error(`No disponible: ${path} (${e.message})`);
            }
        }

        function parseBibTeX(text){
            // Parser simple de BibTeX para extraer entradas
            const entries = [];
            const entryRegex = /@(\w+)\{([^,]+),\s*([\s\S]*?)\n\}\s*(?=@|$)/g;
            let match;
            
            while ((match = entryRegex.exec(text)) !== null) {
                const [, type, id, fieldsText] = match;
                const fields = {};
                
                // Extraer campos individuales
                const fieldRegex = /(\w+)\s*=\s*\{([^}]*)\}/g;
                let fieldMatch;
                while ((fieldMatch = fieldRegex.exec(fieldsText)) !== null) {
                    fields[fieldMatch[1]] = fieldMatch[2];
                }
                
                entries.push({
                    type: type,
                    id: id,
                    fields: fields
                });
            }
            
            return entries;
        }

        function extractAuthors(authorString){
            if(!authorString) return [];
            // Separar autores por 'and'
            return authorString.split(' and ').map(a => a.trim()).filter(a => a);
        }

        function topCounts(items, topN=10){
            const counts = {};
            items.forEach(item => {
                const k = item.trim();
                if(!k) return;
                counts[k] = (counts[k] || 0) + 1;
            });
            const arr = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,topN);
            return arr;
        }

        function renderEntry(entry, index){
            const title = entry.fields.title || 'Sin título';
            const author = entry.fields.author || 'Sin autor';
            const year = entry.fields.year || 'Sin año';
            const type = entry.type || 'unknown';
            
            return `
                <div class="entry-card">
                    <div class="entry-header">
                        <span class="entry-number">#${index + 1}</span>
                        <span class="entry-type">${type}</span>
                        <span class="entry-id">${entry.id}</span>
                    </div>
                    <div class="entry-title">${title}</div>
                    <div class="entry-meta">
                        <div><strong>Autor(es):</strong> ${author}</div>
                        <div><strong>Año:</strong> ${year}</div>
                        ${entry.fields.journal ? `<div><strong>Journal:</strong> ${entry.fields.journal}</div>` : ''}
                        ${entry.fields.booktitle ? `<div><strong>Booktitle:</strong> ${entry.fields.booktitle}</div>` : ''}
                        ${entry.fields.doi ? `<div><strong>DOI:</strong> ${entry.fields.doi}</div>` : ''}
                    </div>
                </div>
            `;
        }

        document.getElementById('loadBtn').addEventListener('click', async function(){
            const btn = this;
            btn.disabled = true;
            showMsg('Cargando...');
            log('Inicio de carga de duplicados');
            document.getElementById('summaryText').textContent = 'Cargando archivo de duplicados...';
            
            try{
                // Fetch duplicados.bib
                let duplicatesText = null;
                try{
                    duplicatesText = await fetchText(paths.duplicates);
                    log('duplicados.bib cargado:', paths.duplicates);
                } catch(e){
                    log(e.message);
                    throw new Error('No se pudo cargar el archivo duplicados.bib. Verifica que el notebook haya generado el archivo.');
                }

                // Parse BibTeX
                const entries = parseBibTeX(duplicatesText);
                log(`Entradas duplicadas parseadas: ${entries.length}`);

                // Mostrar resumen
                const summaryEl = document.getElementById('summaryText');
                summaryEl.innerHTML = `Total de entradas duplicadas: <strong>${entries.length}</strong>`;
                
                const countsEl = document.getElementById('counts');
                countsEl.innerHTML = `<div class="muted">Estas entradas fueron detectadas como duplicadas durante el proceso de consolidación.</div>`;

                // Estadísticas por tipo
                const typeCounts = {};
                entries.forEach(e => {
                    typeCounts[e.type] = (typeCounts[e.type] || 0) + 1;
                });
                
                const statsCard = document.getElementById('statsCard');
                const typeStatsEl = document.getElementById('typeStats');
                if(Object.keys(typeCounts).length > 0){
                    statsCard.style.display = 'block';
                    typeStatsEl.innerHTML = '<table><thead><tr><th>Tipo</th><th>Cantidad</th></tr></thead><tbody>'
                        + Object.entries(typeCounts).sort((a,b)=>b[1]-a[1]).map(t => `<tr><td>${t[0]}</td><td>${t[1]}</td></tr>`).join('')
                        + '</tbody></table>';
                }

                // Top autores
                const allAuthors = [];
                entries.forEach(e => {
                    if(e.fields.author){
                        const authors = extractAuthors(e.fields.author);
                        allAuthors.push(...authors);
                    }
                });
                
                const topAuthors = topCounts(allAuthors, 10);
                const topAuthorsCard = document.getElementById('topAuthorsCard');
                const topAuthorsEl = document.getElementById('topAuthors');
                if(topAuthors.length > 0){
                    topAuthorsCard.style.display = 'block';
                    topAuthorsEl.innerHTML = '<table><thead><tr><th>Autor</th><th>Apariciones</th></tr></thead><tbody>'
                        + topAuthors.map(a => `<tr><td>${a[0]}</td><td>${a[1]}</td></tr>`).join('')
                        + '</tbody></table>';
                }

                // Renderizar entradas
                const entriesListEl = document.getElementById('entriesList');
                if(entries.length > 0){
                    entriesListEl.innerHTML = entries.map((e, i) => renderEntry(e, i)).join('');
                } else {
                    entriesListEl.innerHTML = '<div class="muted">No se encontraron entradas duplicadas.</div>';
                }

                log('Carga finalizada.');
                showMsg('Carga finalizada.');
            } catch(err){
                log('Error general:', err.message);
                showMsg('Error: ' + err.message);
                document.getElementById('summaryText').textContent = 'Error al cargar el archivo. ' + err.message;
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</div>
</body>
</html>
